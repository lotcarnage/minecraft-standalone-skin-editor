# カラーパレット画素埋め込み機能

機能追加実装指示書（独立機能）

## 1. 目的

Minecraft のスキン PNG（64×64）に対して、テクスチャとして参照されない画素領域へカラーパレットを埋め込み、同一ツール内で復元できる機能を追加します。PNG のメタデータは使用しません。スキンとしての見た目やゲーム内表示を変えないことを優先します。

本機能は、本ツールで編集する利点として「パレットを画像に同梱できる」ことを提供します。一方で、他の画像編集ツールや最適化処理によって埋め込み情報が失われる可能性があることは仕様として許容します。埋め込み情報が失われた場合でも、スキン画像そのものは通常の PNG として成立し、破損や表示崩れが起きない設計にします。

## 2. 用語定義と前提

本書では、以下の用語を用います。

UNUSE領域とは、Minecraft の UV 定義に基づき、テクスチャとして参照されない画素座標の集合を指します。本機能におけるカラーパレットの埋め込み先は、この UNUSE領域に限定されます。

USING領域とは、スキン画像全体から UNUSE領域を除いた領域であり、実際にキャラクターモデルのテクスチャとして使用される画素座標の集合を指します。

未使用色はUSING領域内で使われていない色の事です。
画像全体の画素からUNUSE領域を引いてもUSING領域にならないので、未使用色の判定にUNUSE領域は関係ありません。USING領域で使われていない色を未使用色としてください。

対象は 64×64 の Minecraft スキンです。standard / slim の別は本機能の挙動に影響しない前提とします。パレットについては既存仕様として、パレット index 0 を常に完全透明色（RGBA = 0,0,0,0）に固定します。また、復元後のパレット index 1 以降は不透明色として扱い、α値を 255 に正規化します。

この「index 0 は必ず透明」という既存仕様があるため、埋め込みの有無を示すシグネチャを別途持たなくても、抽出・復元処理を一つに統一できます。埋め込みが無い場合は UNUSE領域が透明単色で塗りつぶされていることが多く、抽出結果が自然に既存のパレット生成ロジックへ合流します。

## 3. UNUSE領域（埋め込み領域）の定義

埋め込みに使用する領域は、Minecraft の UV 定義に基づき定義された UNUSE領域です。ここで重要なのは、「見た目上ほぼ使われない」ではなく「仕様として参照されない」ことです。参照されないことが保証されていれば、そこへ何を書いてもゲーム内表示には影響しません。

実装上は、UNUSE領域をコード内の定数テーブルとして定義します。将来 UV の理解や対応範囲が変わる可能性を考えると、UNUSE領域は散在した条件分岐ではなく、座標列や矩形リストの形で一箇所に集約して管理するのが安全です。

なお、読み手は「本当に未使用なのか」「どこかのパーツで参照されるのではないか」と疑問を持つことが想定されます。その疑問に対しては、UNUSE領域が UV テーブルから導出されたものであること、そして UNUSE領域の見直しが必要になった場合でも機能の破壊が起きないこと（後述のフォールバック）によって説明します。

## 4. 埋め込み（書き込み）仕様

埋め込みでは、UNUSE領域の各画素へカラーパレット情報を保存します。保存する情報は RGBA です。保存時には、index 0 以外の有効な色のα値を255として保存します。これは、ブラウザの Canvas API が α=0 の画素の RGB を強制的に破棄してしまうためで、透明のままでは埋め込んだ色を復元できなくなるためです。また、UNUSE領域は Minecraft の UV 仕様上どのパーツからも参照されない領域であり、現行仕様が変わらない限り表示に影響を与えません。そのため、不透明で埋め込んでもゲーム内表示や既存スキンとの互換性に支障はありません。将来もし仕様変更でこの領域が参照されるようになった場合でも、本機能をOFFにしてから画像を書き出すことでUNUSE領域に何も書き込まない通常スキンとして保存できるので運用で対応できます。

UNUSE領域の走査順序は固定します（例として y 昇順、次に x 昇順です）。パレット配列を index 0 から順に UNUSE領域へ書き込みます。色数が UNUSE領域の画素数より少ない場合、残りの画素は RGBA = 0,0,0,0 で埋めます。これは、色が存在しない領域の画素なので復元してはならないためです。色数が UNUSE領域の画素数を超える場合、超過分は切り捨てます。この切り捨ては、画像が壊れないことを優先し、エラーで保存を拒否しないための仕様です。

なお、UNUSE領域に書き込めなかった色については、USING領域においてテクスチャとして使用されている色であることが前提となるため、復元時に順序が変化する可能性はありますが、削除されることはありません。
もし未使用色がUNUSE領域からあふれてしまっても、その色自体は未使用なので復元できなくても問題ないものとして扱います。UNUSE領域に保存できる色数は、本仕様では256色であり、世間的には十分な色数です。

他のツールにより α=0 の RGB 情報が削除または正規化される可能性があることは想定しますが、これは仕様として許容します。情報が失われた場合でも、スキン画像の品質は維持されます。この性質により、他ツールを一度通すことが、UNUSE領域をクリーンアップするサニタイザーとして機能します。

本ツールでは、スキン画像を経由してパレット情報を復元するという設計上、同一の RGB 値を持つ複数のカラーインデックスを、画像往復後も区別したまま保持することはできません。これは、通常のインデックスカラー画像とは異なり、本ツールが RGBA 画像としてスキンを保存しているため、ピクセル値としてカラーインデックスそのものを保持していないことに起因します。

この制約を踏まえ、パレット情報を画像に埋め込む運用においては、パレット index 1 以降において RGB 値が重複していないことを要件とします。RGB 値が重複した状態でスキン画像を書き出した場合、再度読み込みを行う際に、同一色が統合され、元のカラーインデックスの差異が失われます。この状態は、パレットを画像に埋め込み、編集状態を安定して再現するという目的に適しません。

そのため、スキン画像の書き出し時に、パレット index 1 以降を対象として RGB 値の重複検査を行います。重複が検出された場合は、書き出し処理を中断し、エラーダイアログを表示します。エラーダイアログには、重複している RGB 値ごとに、それに該当するすべてのパレットインデックスを列挙し、ユーザーが意図的に修正できる情報を提示します。

この重複判定は RGB 値のみを対象とし、α値は判定に含めません。本ツールの既存仕様として、パレット index 1 以降は不透明色として扱い、復元時に α値を 0か255 に正規化するためです。

## 5. 復元（読み込み）仕様

復元では、まず UNUSE領域から色を抽出し、続いて USING領域から色を抽出します。抽出は固定順序で行い、最初に出現した順序を保持します。色の同一性判定は RGBA 基準とします。ただし、index 1以降の色はカラーパレットか、もしくは存在しない色の領域のため、α値を0か255に正規化してから同一かどうかを判定します。存在しない色の領域であればα値は0です。有効な色であればα値は1以上のはずなので、255に強制的に置き換えて読み込みます。この処理により、index 0 の RGBA = 0,0,0,0 と index 1以降に埋め込まれた RGBA = 0,0,0,255 を区別できます。完全透明色と黒は色として区別できなければなりません。

抽出後に正規化処理を行います。パレット index 0 は常に RGBA = 0,0,0,0 に固定します。重複色は最初に出現したものを残し、それ以外は削除します。これにより、UNUSE領域に埋め込まれた順序が、そのままパレット順序として優先されます。重複色への対応は、既存のスキン画像からパレットを復元する処理と同一の方針で実装します。

ここで想定される懸念として、カラーパレットの誤検出があります。UNUSE領域がランダムな値で汚れている場合、一時的に不要な色が抽出される可能性がありますが、次節で述べる未使用色削除により、USING領域で実際に使用されていない色は除去されます。そのため、最終的な編集結果への影響は限定的です。

パレットの復元ができたらUNUSE領域は編集データから削除してください。

## 6. 未使用色に関する扱い（UNUSE領域由来の色混入について）

既存のスキン画像を読み込み、UNUSE領域をカラーパレットとして復元する場合、UNUSE領域の画素にゴミ値が含まれている可能性があります。これは、他の画像編集ツールや最適化処理を経由した結果、UNUSE領域が意図しない値で上書きされている場合があるためです。

本機能では、このようなゴミ色が一時的にパレットへ含まれる可能性があることを仕様として許容します。UNUSE領域はテクスチャとして使用されない領域であるため、そこに含まれる値は、元画像の見た目やスキンとしての成立性に影響を与えません。

UNUSE領域由来のゴミ色がパレットに含まれた場合でも、それらの色は USING 領域では使用されていない状態で復元されます。そのため、実際の編集作業において問題となることはありません。必要に応じて、エンドユーザーは既存の未使用色削除機能を用いて、USING 領域で使用されていない色を整理できます。

本機能では、読み込み時に未使用色を自動的に削除する処理は行いません。これは、まだ USING 領域で使用されていない色を保持したまま編集を開始する、というパレット編集ツールとしての基本的な利用形態を成立させるためです。

UNUSE領域由来のゴミ色が存在する可能性は、本機能の設計上の制約ではありますが、既存 UI による明示的な整理操作と組み合わせることで、実用上の問題は発生しません。本機能は、カラーパレットの復元と順序の再現に責務を限定し、パレットの取捨選択についてはユーザー判断に委ねます。

## 7. パレット埋め込み機能の ON/OFF

本ツールには、カラーパレットをスキン画像に埋め込むかどうかを制御するための設定として、「パレット埋め込み ON/OFF」を設けます。

パレット埋め込みが OFF の場合、スキン画像の書き出しは従来どおり行われ、UNUSE領域へのカラーパレット情報の書き込みは行いません。パレット埋め込みが ON の場合にのみ、UNUSE領域へパレット情報を画素として埋め込みます。

読み込み時の処理については、パレット埋め込みの ON/OFF によって分岐させません。スキン画像を読み込む際は、常に UNUSE領域にカラーパレットが埋め込まれているものとして処理を行います。これは、画像単体から過去の ON/OFF 状態を厳密に判別することができないこと、および読み込み時に条件分岐を導入すると仕様および実装が複雑化するためです。

この設計により、ON/OFF は書き出し時の挙動と検証条件を制御するための設定として明確に位置づけられ、読み込み処理は常に単一のルールに基づいて動作します。結果として、仕様の一貫性が保たれ、実装および将来の保守が容易になります。

## 8. フォールバックと互換性

本機能におけるフォールバックとは、埋め込み情報が失われても、スキン画像を通常のスキンとして扱える状態に戻ることを指します。埋め込み情報が消えた場合、UNUSE領域からは透明単色または少数の色しか抽出されないことが多く、その後の USING領域の抽出によって、通常のパレット復元処理へ自然に合流します。したがって、埋め込みの有無によって読み込み処理を分岐させる必要はありません。

他ツールとの互換性は保証しません。その代わり、他ツールで埋め込み情報が失われることを、スキンを配布用または通常化するためのサニタイズ手段として利用できる設計とします。この場合でも、スキン画像が壊れないことを最優先とします。

## 9. 非目標

本機能は PNG メタデータの利用、暗号化や難読化、第三者ツール間での埋め込み情報の永続保証を目的としません。また、埋め込み情報の可逆性を保証しません。可逆性よりも、スキン画像としての安全性と、本ツール内での編集体験の安定性を優先します。

## 10. 仕様・要件の要約（実装向け）

本機能の仕様および要件を、実装時に直接参照できる形で以下に整理します。

- 対象は 64×64 の Minecraft スキン PNG のみとする。
- カラーパレットの埋め込み先は、UV 定義上テクスチャとして参照されない UNUSE領域に限定する。
- カラーパレットは画素情報として埋め込み、PNG メタデータは使用しない。
- 埋め込み時は、UNUSE領域の各画素に RGB を書き込み、α値も 255 とする。これは Canvas API が α=0 の RGB を保持しないためであり、埋め込み情報を確実に復元するための設計判断である。
- パレット index 0 は常に完全透明色（RGBA = 0,0,0,0）として扱う。
- パレット index 1 以降は不透明色として扱い、復元時に α値を 0か255 に正規化する。
- UNUSE領域の index 1 以降に存在するα値 0 の画素は、色が埋め込まれていない領域として扱う。
- 復元時の色同一性判定は RGB のみで行い、α値は判定に含めない。
- 復元時は、UNUSE領域 → USING領域の順で色を抽出する。
- 画像読み込み時に未使用色の自動削除はしない。
- 読み込み時の処理は、パレット埋め込み機能の ON/OFF によって分岐させない。
- 他ツールによって埋め込み情報が失われる可能性は仕様として許容する。
- 埋め込み情報が失われても、スキン画像自体が破損しないことを最優先とする。

パレットを画像に埋め込む運用においては、次の制約を設けます。

- パレット index 1 以降において、RGB 値の重複を許可しない。
- スキン画像の書き出し時には、パレット index 1 以降を対象として RGB 重複検査を行う。
- RGB 重複が検出された場合は、書き出し処理を中断し、エラーダイアログを表示する。
- エラーダイアログには、重複している RGB 値と、それに対応するすべてのパレットインデックスを列挙する。

## 付録A. UNUSE領域の座標定義（Minecraft公式スキン仕様準拠）

本付録では、本機能で使用する UNUSE領域の具体的な画素座標を定義します。以下の定義は、Minecraft 公式の 64×64 スキン UV 仕様に基づき、いずれのモデルパーツ（頭部、胴体、腕、脚、および各外層）からも参照されないことが保証されている領域です。

現行仕様において、本機能が使用する UNUSE領域は、頭部テクスチャ（本体側・外殻側）の左右に位置する次の矩形領域とします。

1つ目は、本体側頭部テクスチャの左側に位置する領域です。

- x 座標: 0 ～ 7
- y 座標: 0 ～ 7

2つ目は、本体側頭部テクスチャの右側に位置する領域です。

- x 座標: 24 ～ 31
- y 座標: 0 ～ 7

3つ目は、外殻側頭部テクスチャの左側に位置する領域です。

- x 座標: 32 ～ 39
- y 座標: 0 ～ 7

4つ目は、外殻側頭部テクスチャの右側に位置する領域です。

- x 座標: 48 ～ 55
- y 座標: 0 ～ 7

これら 4 つの 8×8 領域の合計画素数は 256 であり、本機能では最大 256 色のパレット情報を画素として埋め込むことが可能です。

本実装では、安全性と将来の保守性を優先し、UNUSE領域を頭部周辺のこれらの領域のみに限定します。将来の仕様変更や検証により、追加の未参照領域が確認された場合でも、本付録を更新することで対応できるよう、UNUSE領域の定義はコードおよびドキュメントの両方で一元管理するものとします。

## 付録B. エラーダイアログ文言例（重複RGB検出時）

本付録では、パレット埋め込みを前提としたスキン画像書き出し時に、RGB 重複が検出された場合のエラーダイアログ文言例を示します。実際の UI 表現や文言の細部は実装に委ねますが、少なくとも以下の情報がユーザーに明確に伝わることを要件とします。

エラーダイアログには、次の内容を含めてください。

- パレットに重複した色が存在するため、書き出し処理を中断したこと
- 重複している RGB 値
- それぞれの RGB 値に対応するすべてのパレットインデックス

文言例は以下のとおりです。

「パレットに重複した色が存在するため、スキン画像の書き出を中止しました。」

「次の色は、複数のパレットインデックスで同一の RGB 値を持っています。」

- RGB(12, 34, 56): index 5, index 17, index 23
- RGB(0, 0, 0): index 9, index 10

「これらの色の重複を解消したうえで、再度書き出しを行ってください。」

以上
