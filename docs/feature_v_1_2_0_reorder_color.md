# カラーパレット並び替え機能

機能追加実装指示書（既存機能の追加）

## 1. 目的

Minecraft スキンエディタにおけるカラーパレットのスウォッチは現在登録順で固定されています。本機能では、ユーザーがパレット内の色をドラッグアンドドロップで入れ替え、編集工程に合わせた色順へ即座に並び替えられるようにします。手作業で色を消して再登録する手間を排除し、既存のパレット埋め込み機能とも矛盾しない形で色順の整理を行える状態を提供します。

本実装指示書は並び替え操作そのものを対象とし、ドロップダウンやキーボードによる操作追加は範囲外とします。パレット生成・削除・埋め込みなど既存機能の仕様は従来通りです。

## 2. 用語定義

本書でいうカラーパレットとは、エディタ画面に表示される色の配列であり、index 0 から順に RGBA 値が格納される既存のデータ構造を指します。

パレットスウォッチとは、カラーパレット内の各色を表示し、クリックやドラッグで操作できる UI 要素を指します。

ドラッグ元スウォッチとは、ユーザーがポインターダウンして移動を開始したスウォッチを指します。ドラッグ先スウォッチとは、ドラッグ操作中にポインターを重ねてドロップを行う対象スウォッチを指します。

RGB値とは、各スウォッチが保持する RGBA 値のうち、色を識別する RGB 成分を指します。本機能では α 成分も含めた RGBA 値をまとめて交換しますが、仕様説明では「RGB値」という語で入れ替え対象を表現します。

## 3. 前提条件

対象は 64×64 の Minecraft スキン編集機能全体で共有される既存のカラーパレット配列です。標準ボディとスリムボディの区別は本仕様の挙動に影響を与えません。

パレット index 0 は常に完全透明（RGBA = 0,0,0,0）である既存仕様を継承します。ユーザーが透明色を他の色と入れ替えて透明以外が index 0 に配置される状態は許容しません。

## 4. 機能仕様

ユーザーはパレットスウォッチをドラッグすることで並び替え操作を開始します。ドラッグ開始は通常のポインターデバイス（マウス、タッチ）での長押しまたはドラッグ操作に対応させ、既存の色選択クリック挙動と競合しないよう、ドラッグ検出までは従来どおり単一クリックで色を選択できます。

ドラッグ中は、ポインターが他のスウォッチ上に乗った時点で、そのスウォッチをドラッグ先候補として視覚的にハイライトします。ハイライトは CSS セレクターで切り替える専用クラスを付与することで表現し、通常時から無色の枠線を確保した上で色だけを変えるか、`outline` を用いてボックスサイズを変化させない方法とします。これにより枠線が瞬間的に追加されてもレイアウトは変化しません。ハイライトは 1 度に 1 つだけ表示し、ドラッグ先候補が無い場合は表示しません。

ユーザーがドラッグ元スウォッチをドラッグ先スウォッチ上で離した場合、両スウォッチの RGB 値を入れ替えます。スウォッチ配列のインデックス順は物理的に変化させず、各スロットに格納されている RGBA データを交換することで視覚的な並び順を変更します。入れ替え後はパレット表示を再描画し、現在選択中の色が交換後も正しく示されるように選択状態を再評価します。

ドラッグをパレット外で終了した場合、またはドラッグ元とドラッグ先が同一スウォッチであった場合は、入れ替え処理を実行しません。キャンセル時には UI を元の状態へ戻し、ハイライトを全て消去します。

## 5. 処理仕様

パレットデータは既存の配列（例: `palette[index] = { r, g, b, a }`）を用い、各スウォッチに固定長の格納領域を割り当てます。UI はインデックス順にスウォッチを描画しますが、ドラッグ後も DOM やキャンバス上の並び順は変えず、配列内の RGBA 値を入れ替えることで視覚的な並び替えに対応します。

ドラッグ開始時に、ドラッグ元スウォッチの index と RGBA 値を記録します。ドラッグ先候補の決定は、ポインターの現在位置からスウォッチ index を算出する既存のヒットテスト処理を流用し、ドラッグ中は候補 index を逐次更新します。

ドロップ時には候補 index を再評価し、有効なドラッグ先が存在する場合に限り交換を実行します。交換処理は次の手順で行います。

1. `sourceIndex` と `targetIndex` を確定する。
2. `sourceColor` および `targetColor` へ RGBA をコピーする。
3. `palette[sourceIndex] = targetColor`、`palette[targetIndex] = sourceColor` の順で再代入する。

処理は同期的に完了させ、交換後にパレット表示、カラーピッカー、埋め込みモジュールへ新しい配列参照を通知します。

並び替え結果は既存の保存処理と同じく、アプリ内ストレージおよび PNG 埋め込み機能が参照する配列へ即時反映します。これにより、パレットをファイルへ埋め込む際もユーザーが整理した順序がそのまま保持されます。

UIと処理を密結合させないように注意してください。理論的な色の入れ替え処理は、カラーインデックスを指定して色を入れ替える独立性の高い関数として実現できます。UI操作は、その関数を呼び出すための引数、情報を得る手段です。

## 6. 制約・例外

パレット index 0 のスウォッチはドラッグ元・ドラッグ先のどちらにも使用できません。透明色スロットを固定することで、既存仕様の「index 0 は必ず透明」を維持します。UI 上では index 0 にドラッグしてもハイライトを表示せず、ドロップしてもキャンセル扱いとします。技術的に可能であれば、マウスポインターを禁止マークに変えてください。

パレットに 2 色未満しか存在しない場合はドラッグ操作を開始できません。スウォッチ数が 1 の場合は UI 上でドラッグを無効化し、ハイライトも表示しません。

ドラッグ操作中にスウォッチパネルがロックされる（例: ファイル読み込み中やモーダルで入力をブロックしている）場合、進行中のドラッグはキャンセルします。キャンセル時には履歴を残さず、UI を初期状態へ戻します。

## 7. 互換性・非目標

本機能は RGBA 値の交換のみを行い、スキン画像のピクセルデータや履歴に記録された描画ストロークを編集しません。既に描画された画素はそのまま残り、ユーザーは並び替え後に必要な場合のみ再描画します。

ドラッグアンドドロップ以外の並び替え方法（上下ボタン、ショートカットキー等）は本指示書の対象外です。タッチスクリーンでのドラッグには対応しますが、複数スウォッチを同時に選択して並べ替える機能は提供しません。

既存のパレット埋め込み仕様に追加のメタデータは導入しません。交換済みの配列をそのまま保存することで、互換性を維持します。

## 8. Undo/Redo 対応方針（将来拡張）

本ツールには現時点で undo/redo 機能は存在しません。将来的に履歴機能を追加する場合は、ドラッグアンドドロップによる 1 回の入れ替え操作を 1 履歴単位として登録します。履歴の記録タイミングはドロップが成立した瞬間とし、キャンセル扱いのドラッグは記録しません。

履歴エントリーには sourceIndex、targetIndex、交換前後の RGBA 値を格納します。undo 実行時はエントリーに保存した値で RGBA を再交換し、redo 実行時はもう一度同じ交換を行います。同一スウォッチ間で複数回操作した場合でも、それぞれ個別のエントリーとして記録し、巻き戻しは逆順で 1 件ずつ処理します。

## 9. 要約

- 並び替えはパレットスウォッチ間でのドラッグアンドドロップで実行し、視覚的な色順をユーザーが任意に変更できるようにします。
- 並び替え時はスウォッチ配列の index を動かさず、ドラッグ元とドラッグ先の RGBA 値を完全に入れ替えます。
- パレット index 0 は常に透明色のまま固定し、並び替え対象から除外します。
- ドラッグ外れや同一スウォッチへのドロップはキャンセルとして扱い、保存・読み込み・埋め込みの各処理は更新済み配列を即座に参照します。
- undo/redo 追加時は 1 回の入れ替えを 1 履歴単位として記録し、保存するインデックスと RGBA 値で巻き戻し・やり直しを行います。

## 10. 付録A. 操作シーケンス例

1. ユーザーはパレット内の 5 番目のスウォッチをドラッグ元として長押しし、ドラッグを開始します。
2. ポインターを 2 番目のスウォッチ上へ移動すると、そのスウォッチがドラッグ先候補としてハイライトされます。
3. ユーザーが 2 番目のスウォッチ上で指またはマウスボタンを離すと、2 つのスウォッチの RGBA 値が即座に入れ替わり、表示順も更新されます。
4. 現行仕様では履歴を保持しませんが、undo/redo を実装する場合は本操作全体を 1 件の履歴として記録し、逆順の RGBA スワップで巻き戻します。
